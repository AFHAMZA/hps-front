<app-navbar />
<section class="bg-primary position-relative">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 col-md-12">
        <h2 class="ipt-title text-light">WhatsApp Integration</h2>
        <span class="ipn-subtitle">Manage your WhatsApp messages</span>
      </div>
    </div>
  </div>
  <div class="ht-30"></div>
</section>

<section class="gray-simple">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8">
        <div class="card rounded-3 shadow p-4">
          <h4 class="mb-4">Send WhatsApp Messages</h4>
          <div *ngIf="successMessage" class="alert alert-success text-center">{{ successMessage }}</div>
          <div *ngIf="errorMessage" class="alert alert-danger text-center">{{ errorMessage }}</div>

          <ul class="nav nav-tabs mb-4" id="messageTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                [class.active]="activeTab === 'single'"
                id="single-tab"
                type="button"
                (click)="setActiveTab('single')"
              >
                Single Message
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                [class.active]="activeTab === 'broadcast'"
                id="broadcast-tab"
                type="button"
                (click)="setActiveTab('broadcast')"
              >
                Broadcast
              </button>
            </li>
          </ul>

          <div class="tab-content" id="messageTabsContent">
            <!-- Single Message Tab -->
            <div
              class="tab-pane fade"
              [class.show]="activeTab === 'single'"
              [class.active]="activeTab === 'single'"
              id="single"
              role="tabpanel"
            >
              <form [formGroup]="sendMessageForm" (ngSubmit)="sendMessage()">
                <!-- <div class="mb-3">
                  <label class="form-label">Input Type</label>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="manualInput"
                        value="manual"
                        formControlName="inputType"
                      />
                      <label class="form-check-label" for="manualInput">Enter Number</label>
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        id="clientInput"
                        value="client"
                        formControlName="inputType"
                      />
                      <label class="form-check-label" for="clientInput">Select Client</label>
                    </div>
                  </div>
                </div> -->

                <div *ngIf="sendMessageForm.get('inputType')?.value === 'manual'" class="d-flex align-items-center gap-2">
                  <div class="mb-3">
                    <label for="countryCode" class="form-label">Country Code</label>
                    <select class="form-control" id="countryCode" formControlName="countryCode">
                      <option *ngFor="let country of countryCodes" [value]="country.code">{{ country.name }} ({{ country.code }})</option>
                    </select>
                    <div *ngIf="sendMessageForm.get('countryCode')?.touched && sendMessageForm.get('countryCode')?.invalid" class="text-danger">
                      <div *ngIf="sendMessageForm.get('countryCode')?.errors?.['required']">Country code is required</div>
                    </div>
                  </div>
                  <div class="mb-3 flex-grow-1">
                    <label for="phone" class="form-label">Phone Number</label>
                    <input
                      type="tel"
                      class="form-control"
                      id="phone"
                      formControlName="phone"
                      placeholder="123456789"
                    />
                    <div *ngIf="sendMessageForm.get('phone')?.touched && sendMessageForm.get('phone')?.invalid" class="text-danger">
                      <div *ngIf="sendMessageForm.get('phone')?.errors?.['required']">Phone number is required</div>
                      <div *ngIf="sendMessageForm.get('phone')?.errors?.['pattern']">Phone number must be 10-15 digits</div>
                    </div>
                  </div>
                </div>

                <div *ngIf="sendMessageForm.get('inputType')?.value === 'client'" class="mb-3">
                  <label for="clientId" class="form-label">Select Client</label>
                  <select class="form-control" id="clientId" formControlName="clientId">
                    <option value="">-- Select a client --</option>
                    <option *ngFor="let client of clients" [value]="client._id">{{ client.phone }}</option>
                  </select>
                  <div *ngIf="sendMessageForm.get('clientId')?.touched && sendMessageForm.get('clientId')?.invalid" class="text-danger">
                    <div *ngIf="sendMessageForm.get('clientId')?.errors?.['required']">Client is required</div>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="message" class="form-label">Message</label>
                  <textarea
                    class="form-control"
                    id="message"
                    formControlName="message"
                    placeholder="Enter your message"
                  ></textarea>
                  <div *ngIf="sendMessageForm.get('message')?.touched && sendMessageForm.get('message')?.invalid" class="text-danger">
                    <div *ngIf="sendMessageForm.get('message')?.errors?.['required']">Message is required</div>
                  </div>
                </div>
                <button
                  type="submit"
                  class="btn btn-primary full-width"
                  [disabled]="sendMessageForm.invalid || isSendingMessage"
                >
                  <span *ngIf="!isSendingMessage">Send Message</span>
                  <span *ngIf="isSendingMessage">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Sending...
                  </span>
                </button>
              </form>
            </div>

            <!-- Broadcast Tab -->
            <div
              class="tab-pane fade"
              [class.show]="activeTab === 'broadcast'"
              [class.active]="activeTab === 'broadcast'"
              id="broadcast"
              role="tabpanel"
            >

            <div *ngIf="totalClients > pageSize" class="d-flex justify-content-between">
              <button class="btn btn-secondary" (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
                <i class="fa fa-arrow-left"></i>
              </button>
              <span>Page {{ currentPage }} of {{ totalPages }}</span>
              <button class="btn btn-secondary" (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
                <i class="fa fa-arrow-right"></i>
              </button>
            </div>


              <form [formGroup]="broadcastForm" (ngSubmit)="sendBroadcast()">
                <div class="mb-3">
                  <label for="messagePool" class="form-label">Messages (one per line)</label>
                  <textarea
                    class="form-control"
                    id="messagePool"
                    formControlName="messagePool"
                    placeholder="Hello!\nCheck our new offer!\nStay tuned!"
                    title="Enter one message per line. Each client will receive a random message."
                  ></textarea>
                  <div *ngIf="broadcastForm.get('messagePool')?.touched && broadcastForm.get('messagePool')?.invalid" class="text-danger">
                    <div *ngIf="broadcastForm.get('messagePool')?.errors?.['required']">At least one message is required</div>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="clientIds" class="form-label">Select Clients (leave empty for all)</label>
                  <select multiple class="form-control" id="clientIds" formControlName="clientIds">
                    <option *ngFor="let client of clients" [value]="client._id">{{ client.phone }}</option>
                  </select>
                  
                </div>
                
                <div class="alert alert-danger">
                  <strong class="">⚠️Note:</strong> To avoid being flagged or blocked by WhatsApp, do not send too many messages at once. It is recommended to:
                  <ul class="mb-0">
                    <li>Use <strong>small batch sizes</strong> (e.g., 10–20)</li>
                    <li>Set an <strong>interval of at least 5–10 seconds</strong> between batches</li>
                    <li>Vary your messages and avoid sending identical content repeatedly</li>
                  </ul>
                </div>
                
                <div class="mb-3">
                  <label for="batchSize" class="form-label">Batch Size (messages per batch)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="batchSize"
                    formControlName="batchSize"
                    placeholder="10"
                    title="Number of messages to send in each batch (default: 10)"
                  />
                  <div *ngIf="broadcastForm.get('batchSize')?.touched && broadcastForm.get('batchSize')?.invalid" class="text-danger">
                    <div *ngIf="broadcastForm.get('batchSize')?.errors?.['required']">Batch size is required</div>
                    <div *ngIf="broadcastForm.get('batchSize')?.errors?.['min']">Batch size must be at least 1</div>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="intervalMs" class="form-label">Interval Between Batches (milliseconds)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="intervalMs"
                    formControlName="intervalMs"
                    placeholder="5000"
                    title="Delay between batches in milliseconds (default: 5000)"
                  />
                  <div *ngIf="broadcastForm.get('intervalMs')?.touched && broadcastForm.get('intervalMs')?.invalid" class="text-danger">
                    <div *ngIf="broadcastForm.get('intervalMs')?.errors?.['required']">Interval is required</div>
                    <div *ngIf="broadcastForm.get('intervalMs')?.errors?.['min']">Interval must be at least 1000</div>
                  </div>
                </div>
                <button
                  type="submit"
                  class="btn btn-primary full-width"
                  [disabled]="broadcastForm.invalid || isSendingBroadcast"
                >
                  <span *ngIf="!isSendingBroadcast">Send Broadcast</span>
                  <span *ngIf="isSendingBroadcast">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Initiating...
                  </span>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<app-footer-top [bg]="'theme-bg'" />
<app-footer />